<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>BaseBowlingolf Game</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.js"></script>
  <style>
    body { margin:0; padding:0; overflow:hidden; }
    canvas { display:block; }
  </style>
</head>
<body>
<script>
class StartScene extends Phaser.Scene {
  constructor() { super({ key: 'StartScene' }); }

  preload() {
    this.load.image('start', 'image/start.jpg');
    this.load.image('start_button', 'image/start_button.png');
    this.load.image('exit_button', 'image/exit_button.png');
    this.load.image('background', 'image/background.jpg'); 
    this.load.image('background1', 'image/background1.jpg'); 
    this.load.image('start_swing', 'image/start_swing.png'); 
    this.load.image('swing', 'image/swing.png');             
    this.load.image('finish_swing', 'image/finish_swing.png'); 
    this.load.image('pin', 'image/pin.png');
  }

  create() {
    const bg = this.add.image(this.sys.game.config.width/2, this.sys.game.config.height/2, 'start');
    bg.setOrigin(0.5, 0.5);
    this.resizeBackground(bg);

    const btnY = this.sys.game.config.height - 200;
    const spacing = 500;

    const exitBtn = this.add.image(this.sys.game.config.width/2 - spacing, btnY, 'exit_button').setInteractive();
    const startBtn = this.add.image(this.sys.game.config.width/2 + spacing, btnY, 'start_button').setInteractive();

    exitBtn.on('pointerdown', () => { console.log('ê²Œìž„ ì¢…ë£Œ'); });
    startBtn.on('pointerdown', () => { this.scene.start('GameScene'); });
  }

  resizeBackground(bg) {
    const scaleX = this.sys.game.config.width / bg.width;
    const scaleY = this.sys.game.config.height / bg.height;
    bg.setScale(Math.max(scaleX, scaleY));
  }
}

class GameScene extends Phaser.Scene {
  constructor() { super({ key: 'GameScene' }); }

  create() {
    this.physics.world.setBoundsCollision(true, true, true, true);

    // ì´ˆê¸° ë°°ê²½ (ìŠ¤ìœ™ í™”ë©´)
    this.bg = this.add.image(this.sys.game.config.width/2, this.sys.game.config.height/2, 'background');
    this.bg.setOrigin(0.5, 0.5);
    this.resizeBackground(this.bg);

    const swingY = this.sys.game.config.height - 250;
    this.swing = this.add.image(this.sys.game.config.width/2, swingY, 'start_swing').setScale(3);

    this.input.on('pointermove', pointer => {
      const minX = 900;
      const maxX = this.sys.game.config.width - 900;
      this.swing.x = Phaser.Math.Clamp(pointer.x, minX, maxX);
    });

    // í´ë¦­ìœ¼ë¡œ ë‹¤ì‹œ ìŠ¤ìœ™ í™”ë©´ìœ¼ë¡œ ì „í™˜
    this.input.on('pointerdown', () => {
      if (this.readyNextThrow) {
        this.showSwingScreen();
      }
    });

    this.ball = null;
    this.midReached = false;
    this.inBackground1 = false;
    this.canShoot = true;

    this.pins = this.physics.add.group();
    this.score = 0;
    this.frameCount = 1;   // 1~9ì„¸íŠ¸
    this.throwCount = 1;   // ê° ì„¸íŠ¸ì—ì„œ 1êµ¬, 2êµ¬
    this.readyNextThrow = false;

    // ì ìˆ˜ í…ìŠ¤íŠ¸
    this.scoreText = this.add.text(50, 50, `ì ìˆ˜: ${this.score}`, { fontSize: '32px', color: '#ffffff' });

    // ê³µ ë°œì‚¬: ë§ˆìš°ìŠ¤ íœ 
    window.addEventListener('wheel', () => {
      if (!this.canShoot) return;

      this.canShoot = false;
      this.swing.setTexture('swing');
      this.time.delayedCall(200, () => {
        this.swing.setTexture('finish_swing');
        this.ball = this.add.circle(this.swing.x, swingY + 20, 40, 0xff0000);
        this.physics.add.existing(this.ball);
        this.ball.body.setVelocity(0, -300);
        this.ball.setDepth(1);
      });
      this.time.delayedCall(500, () => { this.swing.setTexture('start_swing'); });
    });
  }

  update() {
    // ìŠ¤ìœ™í™”ë©´ â†’ ë°°ê²½1ë¡œ ì „í™˜
    if (this.ball && !this.inBackground1) {
      const targetX = this.sys.game.config.width / 2;
      const targetY = this.sys.game.config.height / 2 - 100;
      const lerpSpeed = 0.05;
      this.ball.x += (targetX - this.ball.x) * lerpSpeed;
      this.ball.y += (targetY - this.ball.y) * lerpSpeed;

      if (!this.midReached && Math.abs(this.ball.y - targetY) < 5) {
        this.midReached = true;
        this.ball.destroy();
        this.ball = null;
        this.showBackground1();
      }
    }

    // ë°°ê²½1ì—ì„œ ê³µì´ ìœ„ìª½ìœ¼ë¡œ ë‚˜ê°€ë©´ ì†Œë©¸
    if (this.inBackground1 && this.ball) {
      if (this.ball.y <= this.sys.game.config.height / 2 - 200) {
        this.ball.destroy();
        this.ball = null;
      }
    }
  }

  // í•€ ìƒì„± (ë°°ê²½1 ì „ìš©)
  createPins() {
    const startX = this.sys.game.config.width / 2 - 200;
    const startY = 600;
    for (let i = 0; i < 5; i++) {
      const pin = this.physics.add.image(startX + i * 100, startY, 'pin');
      pin.setScale(0.5);
      pin.setOrigin(0.5, 1);
      pin.body.setAllowRotation(true);
      pin.body.setImmovable(true);
      pin.body.allowGravity = false;
      pin.fallen = false;
      pin.checkedDomino = false;
      this.pins.add(pin);
    }
  }

  // ë°°ê²½1 í‘œì‹œ + í•€ ìƒì„±
    showBackground1() {
      if (this.bg) this.bg.destroy();
      this.bg = this.add.image(this.sys.game.config.width/2, this.sys.game.config.height/2, 'background1');
      this.bg.setOrigin(0.5, 0.5);
      this.resizeBackground(this.bg);
      this.inBackground1 = true;

      // ìƒˆ í”„ë ˆìž„ ì‹œìž‘ì¼ ê²½ìš°ì—ë§Œ í•€ ë¦¬ì…‹
      if (this.throwCount === 1) {
        this.pins.clear(true, true);
        this.createPins();
      }

      this.pins.getChildren().forEach(pin => {
        if (pin.fallen) {
          pin.setVisible(false);   // ì´ë¯¸ ì“°ëŸ¬ì§„ í•€ì€ ê³„ì† ìˆ¨ê¹€
        } else {
          pin.setVisible(true);    // ì•ˆ ì“°ëŸ¬ì§„ í•€ì€ ë‹¤ì‹œ ë³´ì´ê²Œ
          pin.body.enable = true;  // ì¶©ëŒ ê°€ëŠ¥í•˜ê²Œ ë‹¤ì‹œ ì¼œì¤Œ
        }
      });


      // ê³µ ìƒì„±
      this.ball = this.add.circle(this.swing.x, this.sys.game.config.height - 50, 40, 0xff0000);
      this.physics.add.existing(this.ball);
      this.ball.body.setVelocity(0, -300);
  this.ball.setDepth(1);

    // ê³µê³¼ í•€ ì¶©ëŒ ì²˜ë¦¬
      this.physics.add.collider(this.ball, this.pins, (ball, pin) => {
        if (pin.fallen) return;
        const targetAngle = (ball.x < pin.x ? -90 : 90);
        this.tweens.add({
          targets: pin,
          angle: targetAngle,
          duration: 500,
          ease: 'Cubic.easeOut',
          onComplete: () => {
            pin.fallen = true;  
            pin.setVisible(false);   // ì“°ëŸ¬ì§„ í•€ì€ í™”ë©´ì—ì„œ ìˆ¨ê¹€
            this.updateScore();
          }
        });
        this.ball.destroy();
        this.ball = null;
      });


    // í•€ê³¼ í•€ ë„ë¯¸ë…¸ íš¨ê³¼
    this.physics.add.collider(this.pins, this.pins, (pinA, pinB) => {
      if (!pinB.fallen && pinA.fallen && !pinB.checkedDomino) {
        pinB.checkedDomino = true;
        if (Math.random() < 0.3) {
          const direction = (pinA.x < pinB.x ? -90 : 90);
          this.tweens.add({
            targets: pinB,
            angle: direction,
            duration: 500,
            ease: 'Cubic.easeOut',
            onComplete: () => {
              pinB.body.enable = false;
              pinB.fallen = true;
              this.updateScore();
            }
          });
        }
      }
    });
  }

  // ì ìˆ˜ ì—…ë°ì´íŠ¸
  updateScore() {
    const fallenCount = this.pins.getChildren().filter(pin => pin.fallen).length;
    this.score = fallenCount + (this.frameCount - 1) * 5; // ë‹¨ìˆœ ëˆ„ì 
    this.scoreText.setText(`ì ìˆ˜: ${this.score}`);
    this.readyNextThrow = true;
  }

  // ë‹¤ì‹œ ìŠ¤ìœ™ í™”ë©´
    showSwingScreen() {
    if (this.bg) this.bg.destroy();
    this.bg = this.add.image(this.sys.game.config.width/2, this.sys.game.config.height/2, 'background');
    this.bg.setOrigin(0.5, 0.5);
    this.resizeBackground(this.bg);

    this.inBackground1 = false;
    this.midReached = false;
    this.canShoot = true;
    this.readyNextThrow = false;

    // ðŸŽ¯ ìŠ¤ìœ™ ì´ë¯¸ì§€ ë‹¤ì‹œ ìƒì„±
    const swingY = this.sys.game.config.height - 250;
    if (this.swing) this.swing.destroy();
    this.swing = this.add.image(this.sys.game.config.width/2, swingY, 'start_swing').setScale(3);

    this.throwCount++;

    // í”„ë ˆìž„ ë (2êµ¬ ë§ˆì¹˜ë©´)
    if (this.throwCount > 2) {
      this.throwCount = 1;
      this.frameCount++;

      if (this.frameCount > 9) {
        this.add.text(this.sys.game.config.width/2 - 200, this.sys.game.config.height/2, 
          `ê²Œìž„ ì¢…ë£Œ! ì´ ì ìˆ˜: ${this.score}`, { fontSize: '48px', color: '#ff0000' });
        this.canShoot = false;
      }
    }
}


  resizeBackground(bg) {
    const scaleX = this.sys.game.config.width / bg.width;
    const scaleY = this.sys.game.config.height / bg.height;
    bg.setScale(Math.max(scaleX, scaleY));
  }
}

const config = {
  type: Phaser.AUTO,
  width: window.innerWidth,
  height: window.innerHeight,
  physics: { default: 'arcade', arcade: { debug: false } },
  scene: [StartScene, GameScene]
};

const game = new Phaser.Game(config);

window.addEventListener('resize', () => {
  game.scale.resize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
